{% extends "base.html" %}

{% block content %}

<head>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<div class="container mt-5">
    <h1 class="text-center mb-4">Bill Information</h1>

    <div class="card p-4 mb-5">
        <h2 class="text-center mb-3">Table {{ bill.table_number }}</h2>
        <p><strong>Bill ID:</strong> {{ bill._id }}</p>
        <p><strong>Date:</strong> {{ bill.created_at.date()}}</p>
        <hr>

        <h3 class="mt-4 mb-3">Items Ordered</h3>
        <table class="table table-striped fs-6" style="table-layout: fixed;">
            <thead>
                <tr>
                    <th>Item</th>
                    <th>Qty</th>
                    <th>Price</th>
                    <th>Subtotal</th>
                    <!-- <th></th> -->
                </tr>
            </thead>
            <tbody>
                {% for item in bill.contents %}
                <tr>
                    <td class="align-content-center">{{ item.name }}</td>
                    <td class="align-content-center">{{ item.quantity }}</td>
                    <td class="align-content-center">${{ "%.2f"|format(item.price) }}</td>
                    <td class="w-50 align-content-center">${{ "%.2f"|format(item.price * item.quantity) }}</td>
                    <td class="d-flex align-content-center justify-content-end">
                        <a href="{{ url_for('vendor_bills.delete_from_bill', bill_id=bill._id, item_id=item._id) }}"
                           class="btn fa fs-5 text-muted">&#xf014;</a>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="5" class="text-center text-muted">No items found.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <div class="text-end mt-4">
            <p><strong>Subtotal:</strong> ${{ "%.2f"|format(bill.subtotal) }}</p>
            <p><strong>Tax ({{ "%.2f"|format(tax) }}%):</strong> ${{ "%.2f"|format(bill.subtotal * tax / 100) }}</p>
            <h4><strong>Total:</strong> ${{ "%.2f"|format(bill.subtotal + (bill.subtotal * tax / 100)) }}</h4>
        </div>

        <!--  GROUP PANEL (added) -->
        <hr>
        <div class="row">
          <div class="col-md-12">
            <h3 class="mb-3">Group</h3>

            {% if group %}
              <div class="card p-3 mb-3">
                <p class="mb-1"><strong>Name:</strong> {{ group.name }}</p>
                {% if group.get('join_code') %}
                  <p class="mb-1"><strong>Join Code:</strong> <code>{{ group.join_code }}</code></p>
                {% endif %}
                <p class="mb-2"><strong>Members:</strong></p>
                {% if group.members and group.members|length > 0 %}
                  <ul class="mb-3">
                    {% for uid in group.members %}
                      <li>{{ uid }}</li>
                    {% endfor %}
                  </ul>
                {% else %}
                  <p class="text-muted">No members yet.</p>
                {% endif %}

                <!-- Detach form -->
                <form method="POST" action="{{ url_for('vendor_bills.detach_group_from_bill') }}">
                  <input type="hidden" name="bill_id" value="{{ bill._id }}">
                  <button class="btn btn-outline-danger btn-sm">Detach Group</button>
                </form>
              </div>
            {% else %}
              <div class="card p-3 mb-3">
                <p class="text-muted mb-2">No group is attached to this bill.</p>

                {% if groups and groups|length > 0 %}
                  <!-- Attach form -->
                  <form method="POST" action="{{ url_for('vendor_bills.attach_group_to_bill') }}" class="d-flex gap-2">
                    <input type="hidden" name="bill_id" value="{{ bill._id }}">
                    <select class="form-select" name="group_id" required>
                      <option value="" disabled selected>Select a groupâ€¦</option>
                      {% for g in groups %}
                        <option value="{{ g._id }}">{{ g.name }}</option>
                      {% endfor %}
                    </select>
                    <button class="btn btn-primary">Attach</button>
                  </form>
                {% else %}
                  <p class="text-muted">You have no groups yet. Create one from the Groups screen.</p>
                {% endif %}
              </div>
            {% endif %}
          </div>
        </div>
        <!--  GROUP PANEL (added)  -->

        <hr>
        <div class="d-flex justify-content-around">
            <a href="{{ url_for('vendor_bills.delete', bill_id=bill._id) }}" class="btn btn-danger w-25">Delete</a>
            <a href="{{ url_for('vendor_bills.view_menu_for_bill', bill_id=bill._id) }}"
               class="btn btn-primary w-25">Add to Bill</a>
        </div>
    </div>
</div>
{% endblock %}
